#!/bin/bash
# NOTE: Typically, this file needs to be sourced, rather than executed

# Copyright 2023 Chainguard, Inc.
# Author: Dustin Kirkland <kirkland@chainguard.dev>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

HELP="
These are set of shell functions that facilitate package and image development
on Wolfi and Chainguard, within a command line environment.

Below, you can find some helpful hints on the available commands, and what
they do...

 - wolfi-branch [BRANCH_NAME]: Get your branch of the WOlfi OS source code
   - NOTE: You must set GH_USER to your github username
 - wolfi-grype [TARGET]: Run grype on a given target
 - wolfi-local: Launch latest Wolfi in a docker container, with a local package repository
 - wolfi-sdk: Launch latest Wolfi in a docker container for building packages
 - wolfi-shell: Launch latest Wolfi in a docker container
 - wolfi-source: Get the current Wolfi OS source code
 - wolfi-yam: Reformat yaml to Wolfi specifications
"

function info() {
	echo "INFO: $@"
}

function error() {
	echo "ERROR: $@" 1>&2
}

function wolfi() {
	echo "$HELP"
}

function _wolfi-check-deps() {
	type gh 2>&1 >/dev/null || error "You need to install 'git':\n sudo apt install gh"
	type git 2>&1 >/dev/null || error "You need to install 'git':\n sudo apt install git"
	type docker 2>&1 >/dev/null || error "You need to install 'git':\n sudo apt install docker"
	type melange 2>&1 >/dev/null || error "You need to install 'melange':\n go install chainguard.dev/melange@latest"
	type terraform 2>&1 >/dev/null || error "You need to install 'terraform':\n go install github.com/hashicorp/terraform@latest"
	type yam 2>&1 >/dev/null || error "You need to install 'yam':\n go install chainguard.dev/yam@latest"
	export TERRAFORM=$(command -v terraform)
}

_wolfi-check-deps

function wolfi-branch() {
	local URL="git@github.com:$GH_USER/wolfi-os.git"
	[ -z "$1" ] && error "You must specify a branch name" && return
	local BRANCH="$1"
	[ -z "$GH_USER" ] && error "You must set GH_USER to your github username" && return
	gh repo sync $GH_USER/wolfi-os -b "$BRANCH"
	local DIR=$(mktemp -d wolfi-XXXXXXXX)
	cd "$DIR"
	git clone "$URL" wolfi-os || error "Ensure that your fork is named 'wolfi-os'"
	cd wolfi-os
	git switch "$BRANCH" || git branch "$BRANCH" && git switch "$BRANCH"
	git push origin -u "$1"
	git config pull.rebase true
}

function wolfi-grype() {
	docker pull cgr.dev/chainguard/grype:latest
	docker run --rm -ti cgr.dev/chainguard/grype "$@"
}

function _wolfi-latest() {
	# Internal function, ensure we have latest wolfi in our local docker image cache
	docker pull cgr.dev/chainguard/wolfi-base:latest
}

function wolfi-local() {
	_wolfi-latest
	grep -qs "This is the main package repository for the Wolfi project" README.md 2>/dev/null || wolfi-source
	mkdir -p packages
	[ -f local-melange.rsa ] || melange keygen local-melange.rsa
	make local-wolfi
}

function wolfi-sdk() {
	_wolfi-latest
	grep -qs "This is the main package repository for the Wolfi project" README.md 2>/dev/null || wolfi-source
	make dev-container
}

function wolfi-shell() {
	_wolfi-latest
	docker run --rm -it $DOCKER_RUN_OPTS -v bash cgr.dev/chainguard/wolfi-base:latest "$@"
}

function wolfi-source() {
	local OS_URL="git@github.com:wolfi-dev/os.git"
	local IMAGES_URL="git@github.com:chainguard-images/images.git"
	local DIR="$PWD"/$(mktemp -d wolfi-XXXXXXXX)
	mkdir -p "$DIR/github.com/wolfi-dev/"
	cd "$DIR/github.com/wolfi-dev/"
	git clone --depth=1 "$OS_URL" os
	mkdir -p "$DIR/github.com/chainguard-images/"
	cd "$DIR/github.com/chainguard-images/"
	git clone --depth=1 "$IMAGES_URL" images
	cd "$DIR"/github.com
	info "You now have a clean clone of wolfi-dev/os and chainguard-images/images"
}

function wolfi-image() {
	wolfi-source
	cd chainguard-images/images
	make init
	make image/$1
}

function wolfi-image-new() {
	wolfi-source
	cd chainguard-images/images
	make init
	# To generate scaffolding for new image:
	# 1=image name, 2=entry point
	go run ./monopod/monopod.go scaffold "$1" --entrypoint "$2"
	info "Generated images/$1"
}

function wolfi-yaml() {
	yam "$@"
}

# First step in making images, is a make init in images directory
